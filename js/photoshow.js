(function($){$.fn.photoshow=function(){return this.each(function(){var frame=$(this),t=frame.attr('title'),conf={};try{conf=$.parseJSON(t);}catch(e){conf={filter:t};}frame.removeAttr('title');ps=new $.photoshow(frame,conf);});};$.photoshow=function(frame,conf){this.frame=frame;this.w=this.frame.width();this.h=this.frame.height();this.filter=conf.filter;this.timeout=(typeof conf.timeout!='undefined')?conf.timeout:10000;this.limit=conf.limit||10;this.api_key=flickr_api_key||'';this.images_list=[];this.setLoadingImg();this.getImagesList(this.filter);};$.photoshow.prototype={hide:function(){this.frame.hide('fast');},yql:function(query,successCallback,errorCallback){$.ajax({url:"http://query.yahooapis.com/v1/public/yql",dataType:"jsonp",success:function(content,status){if(successCallback)successCallback(content);},error:function(){if(errorCallback)errorCallback();},data:{q:query,format:"json"}});},getImagesList:function(){var me=this,query='select * from flickr.photos.info where api_key="'+this.api_key+'" and photo_id in(select id from flickr.photos.search where api_key="'+this.api_key+'" and license=4 and ',terms=this.filter.split(',');for(var i=0,l=terms.length;i<l;i++){terms[i]='text="'+terms[i]+'"';}query+='('+terms.join(' OR ')+') limit '+this.limit+')';this.yql(query,function(c){var r=c.query.results;if(r){var p=r.photo,l=p.length;if(l){for(var i=0;i<l;i++){me.images_list[me.images_list.length]={url:'http://farm'+p[i].farm+'.static.flickr.com/'+p[i].server+'/'+p[i].id+'_'+p[i].secret+'_m.jpg',alt:((p[i].title)?p[i].title+' ':'')+'By '+p[i].owner.realname};}me.loadNextImage();}else{me.hide();}}else{me.hide();}},function(){me.hide();});},setLoadingImg:function(){var offset=this.frame.offset();$('<div class="loading" style="margin-left:'+(this.w/2-12)+'px;margin-top:'+(this.h/2-12)+'px;"></div>').appendTo(this.frame);},rmvLoadingImg:function(){$('.loading',this.frame).remove();this.rmvLoadingImg=function(){};},loadImage:function(img){var me=this;$('<img src="'+img['url']+'" class="hidden" title="'+img['alt']+'" />').appendTo(me.frame).bind('load',function(){var jImg=$(this);me.rmvLoadingImg();me.resize(jImg);me.show(jImg);});},resize:function(jImg){var w=jImg.width(),h=jImg.height(),aw,ah;if(w>this.w){aw=this.w;h=aw*h/w;w=aw;}if(h>this.h){ah=this.h;w=ah*w/h;h=ah;}jImg.width(w);jImg.height(h);},loadNextImage:function(){this.index=(typeof this.index!='undefined'&&this.index+1<this.images_list.length)?this.index+1:0;this.loadImage(this.images_list[this.index]);},show:function(jImg){var me=this;$('img.show',me.frame).hide('slow',function(){$(this).remove();});jImg.show('slow',function(){jImg.addClass('show').removeClass('hidden');if(me.timeout)setTimeout(function(){me.loadNextImage();},me.timeout);});}};})(jQuery);jQuery(function(){jQuery('.photoshow').photoshow();});